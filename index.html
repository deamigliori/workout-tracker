<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
        }

        .container {
            padding: 20px;
            width: 100%;
        }

        .table-container {
            position: relative;
            margin: 20px 0;
            border: 1px solid #ddd;
        }

        /* Tabela de nomes (fixa à esquerda) */
        .names-table {
            position: absolute;
            left: 0;
            top: 0;
            width: 120px;
            background: white;
            z-index: 2;
            border-right: 2px solid #ddd;
        }

        .names-table th,
        .names-table td {
            border-bottom: 1px solid #ddd;
            padding: 8px;
            height: 41px; /* Garante alinhamento com a tabela principal */
            background: white;
        }

        /* Container de rolagem */
        .scroll-container {
            overflow-x: auto;
            margin-left: 120px; /* Largura da tabela de nomes */
            padding-bottom: 15px; /* Espaço para barra de rolagem */
        }

        /* Tabela principal */
        .main-table {
            border-collapse: collapse;
            min-width: 100%;
            background: white;
        }

        .main-table th,
        .main-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            min-width: 100px;
        }

        .main-table th {
            background: #f5f5f5;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        /* Tabela de totais (fixa à direita) */
        .totals-table {
            position: absolute;
            right: 0;
            top: 0;
            background: white;
            z-index: 2;
            border-left: 2px solid #ddd;
        }

        .totals-table th,
        .totals-table td {
            border-bottom: 1px solid #ddd;
            padding: 8px;
            height: 41px;
        }

        /* Estilos comuns */
        input[type="number"] {
            width: 50px;
            padding: 5px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .leader { background-color: #e8f5e9 !important; }
        .last-place { background-color: #ffebee !important; }

        .progress-container {
            width: 150px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar {
            height: 20px;
            border-radius: 10px;
            transition: width 0.5s;
            color: white;
            text-align: right;
            padding-right: 5px;
            font-size: 12px;
            line-height: 20px;
        }

        .progress-level-1 { background-color: #9e9e9e; }
        .progress-level-2 { background-color: #9c27b0; }
        .progress-level-3 { background-color: #2196f3; }
        .progress-level-4 { background-color: #4caf50; }

        .info-box {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }

        .syncing {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            display: none;
        }

        @media screen and (max-width: 768px) {
            .container { padding: 10px; }
            input[type="number"] { 
                width: 40px;
                padding: 3px;
            }
            .names-table { width: 100px; }
            .scroll-container { margin-left: 100px; }
        }
    </style>
</head>
<body>
    <div id="syncing" class="syncing">Sincronizando...</div>

    <div class="container">
        <h1 style="text-align: center; margin-bottom: 20px;">Controle do Desafio de Ginástica</h1>

        <div class="table-container">
            <!-- Tabela de nomes (fixa à esquerda) -->
            <div class="names-table">
                <table>
                    <thead>
                        <tr><th>Participante</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>Andréa</td></tr>
                        <tr><td>Cláudia</td></tr>
                        <tr><td>Isabela</td></tr>
                        <tr><td>Fabiana</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Container com rolagem horizontal -->
            <div class="scroll-container">
                <table class="main-table" id="workoutTable">
                    <thead>
                        <tr id="headerRow"></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Tabela de totais (fixa à direita) -->
            <div class="totals-table">
                <table>
                    <thead>
                        <tr>
                            <th>Total</th>
                            <th>Saldo (€)</th>
                            <th>Progresso</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="total">0</td>
                            <td class="balance">0</td>
                            <td class="progress"></td>
                        </tr>
                        <tr>
                            <td class="total">0</td>
                            <td class="balance">0</td>
                            <td class="progress"></td>
                        </tr>
                        <tr>
                            <td class="total">0</td>
                            <td class="balance">0</td>
                            <td class="progress"></td>
                        </tr>
                        <tr>
                            <td class="total">0</td>
                            <td class="balance">0</td>
                            <td class="progress"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="info-box">
            <h3>Informações do Desafio:</h3>
            <p>• Período: 06/01/2025 - 31/07/2025</p>
            <p>• Objetivo: 3 atividades por semana</p>
            <p>• Máximo de atividades por semana: 3</p>
            <p>• Multa por atividade não realizada: 10€</p>
            <p id="leaderInfo"></p>
        </div>
    </div>

    <script>
        const startDate = new Date('2025-01-06');
        const endDate = new Date('2025-07-31');
        const participants = ['Andréa', 'Cláudia', 'Isabela', 'Fabiana'];
        let cachedData = null;

        function generateWeeks() {
            const weeks = [];
            let currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                const weekStart = new Date(currentDate);
                const weekEnd = new Date(currentDate);
                weekEnd.setDate(weekEnd.getDate() + 6);
                weeks.push({
                    start: formatDate(weekStart),
                    end: formatDate(weekEnd)
                });
                currentDate.setDate(currentDate.getDate() + 7);
            }
            return weeks;
        }

        function formatDate(date) {
            return date.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        async function loadData() {
            try {
                document.getElementById('syncing').style.display = 'block';
                const response = await fetch('data.json?' + new Date().getTime());
                if (!response.ok) throw new Error('Erro ao carregar dados');
                const data = await response.json();
                cachedData = data.workoutData || {};
                return cachedData;
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                return {};
            } finally {
                document.getElementById('syncing').style.display = 'none';
            }
        }

        async function initializeTable() {
            const weeks = generateWeeks();
            const savedData = await loadData();
            const headerRow = document.getElementById('headerRow');
            const tbody = document.querySelector('#workoutTable tbody');
            
            // Limpar conteúdo existente
            headerRow.innerHTML = '';
            tbody.innerHTML = '';
            
            // Criar cabeçalhos
            weeks.forEach((week, index) => {
                const th = document.createElement('th');
                th.innerHTML = `Semana ${index + 1}<br>${week.start} - ${week.end}`;
                headerRow.appendChild(th);
            });
            
            // Criar linhas para cada participante
            participants.forEach(participant => {
                const row = document.createElement('tr');
                row.dataset.participant = participant;
                
                weeks.forEach((_, weekIndex) => {
                    const td = document.createElement('td');
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.min = '0';
                    input.max = '3';
                    input.value = savedData[participant]?.[weekIndex] || 0;
                    input.onchange = handleWorkoutUpdate;
                    td.appendChild(input);
                    row.appendChild(td);
                });
                
                tbody.appendChild(row);
            });
            
            updateTotalsAndRankings();
        }

        function updateTotalsAndRankings() {
            const weeks = generateWeeks();
            const rows = document.querySelectorAll('#workoutTable tbody tr');
            let maxTotal = 0;
            let minTotal = Infinity;
            let totals = [];

            rows.forEach((row, rowIndex) => {
                const inputs = row.querySelectorAll('input');
                const total = Array.from(inputs).reduce((sum, input) => sum + (parseInt(input.value) || 0), 0);
                const participant = row.dataset.participant;

                // Atualizar células de total e saldo
                const totalCells = document.querySelectorAll('.total');
                const balanceCells = document.querySelectorAll('.balance');
                const progressCells = document.querySelectorAll('.progress');

                totalCells[rowIndex].textContent = total;

                const totalWeeks = weeks.length;
                const balance = (total * 10) - (totalWeeks * 3 * 10);
                balanceCells[rowIndex].textContent = balance + '€';

                // Atualizar barra de progresso
                const maxPossible = totalWeeks * 3;
                const percentage = (total / maxPossible) * 100;
                let progressClass = 'progress-level-1';
                
                if (percentage >= 80) progressClass = 'progress-level-4';
                else if (percentage >= 50) progressClass = 'progress-level-3';
                else if (percentage >= 20) progressClass = 'progress-level-2';

                progressCells[rowIndex].innerHTML = `
                    <div class="progress-container">
                        <div class="progress-bar ${progressClass}" style="width: ${percentage}%">
                            ${Math.round(percentage)}%
                        </div>
                    </div>
                `;

                maxTotal = Math.max(maxTotal, total);
                minTotal = Math.min(minTotal, total);
                totals.push({ name: participant, total });
            });

            // Atualizar líderes e últimos
            const nameRows = document.querySelectorAll('.names-table tbody tr');
            nameRows.forEach((row, index) => {
                const total = parseInt(document.querySelectorAll('.total')[index].textContent);
                row.classList.remove('leader', 'last-place');
                if (total === maxTotal && total > 0) row.classList.add('leader');
                if (total === minTotal && total > 0) row.classList.add('last-place');
            });

            // Atualizar informação do líder
            const leaders = totals.filter(t => t.total === maxTotal && t.total > 0);
            const leaderInfo = document.getElementById('leaderInfo');
            if (leaders.length > 0) {
                const leaderText = leaders.length > 1 ? 'Líderes atuais' : 'Líder atual';
                const leaderNames = leaders.map(l => l.name).join(', ');
                leaderInfo.textContent = `• ${leaderText}: ${leaderNames} com ${maxTotal} atividades`;
                leaderInfo.style.color = '#4caf50';
            } else {
                leaderInfo.textContent = '';
            }
        }

        let updateTimeout;
        async function handleWorkoutUpdate(event) {
            const input = event.target;
            input.value = Math.max(0, Math.min(3, parseInt(input.value) || 0));
            
            const row = input.closest('tr');
            const participant = row.dataset.participant;
            const weekIndex = Array.from(row.children).indexOf(input.parentElement);
            
            if (!cachedData[participant]) cachedData[participant] = {};
            cachedData[participant][weekIndex] = parseInt(input.value);
            
            updateTotalsAndRankings();
            
            // Debounce para evitar muitas atualizações
            clearTimeout(updateTimeout);
            updateTimeout = setTimeout(() => {
                localStorage.setItem('workoutDataBackup', JSON.stringify(cachedData));
            }, 1000);
        }

        // Inicializar a tabela quando a página carregar
        window.addEventListener('load', initializeTable);
    </script>
</body>
</html>
